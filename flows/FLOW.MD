# âš™ï¸ LUá»’NG Xá»¬ LÃ AUTHENTICATION

## ğŸ§­ LUá»’NG 1: ÄÄ‚NG KÃ (Local Account)

### Flow:

1. NgÆ°á»i dÃ¹ng Ä‘iá»n form Ä‘Äƒng kÃ½: email + máº­t kháº©u + tÃªn + sÄ‘t...
2. Server gá»i `_userManager.CreateAsync()` táº¡o user má»›i.
3. LÆ°u vÃ o:
   - **AspNetUsers**: thÃ´ng tin email, password hash.
   - **CustomerProfiles**: thÃ´ng tin FullName, Phone, Address,...
   - _(Option)_ **AspNetUserClaims**: `"is_verified": false`.

### ğŸ’¾ Database tÆ°Æ¡ng tÃ¡c:

| **Báº£ng**             | **Vai trÃ²**                                     |
| -------------------- | ----------------------------------------------- |
| **AspNetUsers**      | Táº¡o user má»›i                                    |
| **CustomerProfiles** | Táº¡o há»“ sÆ¡ ngÆ°á»i dÃ¹ng                            |
| **AspNetUserClaims** | Gáº¯n cÃ¡c Ä‘áº·c tÃ­nh (claim) nhÆ° tier, verified,... |

---

## ğŸ” LUá»’NG 2: ÄÄ‚NG NHáº¬P (Local Login)

### Flow:

1. NgÆ°á»i dÃ¹ng gá»­i email + máº­t kháº©u.
2. Server kiá»ƒm tra há»£p lá»‡ â†’ Ä‘Äƒng nháº­p thÃ nh cÃ´ng.
3. Server dÃ¹ng OpenIddict Ä‘á»ƒ cáº¥p:
   - `access_token`
   - `refresh_token`
   - CÃ¡c claim nhÆ° email, role, tier, is_verified sáº½ Ä‘Æ°á»£c Ä‘Æ°a vÃ o token (láº¥y tá»« DB).

### ğŸ’¾ Database tÆ°Æ¡ng tÃ¡c:

| **Báº£ng**                                                     | **DÃ¹ng Ä‘á»ƒ**                  |
| ------------------------------------------------------------ | ---------------------------- |
| **AspNetUsers**                                              | So khá»›p user/password        |
| **AspNetUserClaims**                                         | ÄÆ°a claim vÃ o token          |
| **AspNetUserRoles** + **AspNetRoles** + **AspNetRoleClaims** | PhÃ¢n quyá»n vÃ  cáº¥p quyá»n Ä‘á»™ng |
| **AspNetUserTokens**                                         | LÆ°u `refresh_token` náº¿u cáº§n  |

---

## ğŸ§­ LUá»’NG 3: ÄÄ‚NG NHáº¬P Báº°NG GOOGLE

### Flow:

1. NgÆ°á»i dÃ¹ng click â€œSign in with Googleâ€ â†’ Redirect tá»›i Google.
2. Google xÃ¡c thá»±c â†’ redirect láº¡i vá» Auth Server.
3. Auth Server:
   - Náº¿u user chÆ°a tá»“n táº¡i â†’ táº¡o user má»›i trong **AspNetUsers**.
   - LÆ°u vÃ o **AspNetUserLogins**:
     - `LoginProvider = Google`
     - `ProviderKey = <google_id>`
   - Cáº¥p `access_token` nhÆ° login bÃ¬nh thÆ°á»ng.
   - Táº¡o **CustomerProfile** náº¿u chÆ°a cÃ³.

### ğŸ’¾ Database tÆ°Æ¡ng tÃ¡c:

| **Báº£ng**             | **DÃ¹ng Ä‘á»ƒ**                        |
| -------------------- | ---------------------------------- |
| **AspNetUsers**      | Táº¡o user má»›i                       |
| **AspNetUserLogins** | LÆ°u login báº±ng Google              |
| **CustomerProfiles** | Táº¡o há»“ sÆ¡ cÃ¡ nhÃ¢n má»›i              |
| **AspNetUserClaims** | CÃ³ thá»ƒ lÆ°u email, avatar tá»« Google |

---

## ğŸ§  LUá»’NG 4: Cáº¤P TOKEN (OAuth2 + PKCE)

1. Khi user login xong â†’ Auth Server cáº¥p `authorization_code`.
2. App frontend (React, Razor) gá»­i `POST /connect/token`.
3. Auth Server xÃ¡c minh â†’ tráº£ vá»:
   - `access_token` (thÆ°á»ng lÃ  JWT).
   - `refresh_token` (lÆ°u vÃ o **AspNetUserTokens**).
4. Token nÃ y sáº½ Ä‘Æ°á»£c client dÃ¹ng Ä‘á»ƒ gá»i cÃ¡c API.

---

## ğŸ” LUá»’NG 5: REFRESH TOKEN

1. Khi `access_token` háº¿t háº¡n â†’ frontend dÃ¹ng `refresh_token` gá»­i lÃªn `/connect/token`.
2. Auth Server tÃ¬m `refresh_token` trong **AspNetUserTokens**, xÃ¡c minh.
3. Náº¿u há»£p lá»‡ â†’ cáº¥p `access_token` má»›i.

### ğŸ’¾ Database tÆ°Æ¡ng tÃ¡c:

| **Báº£ng**             | **Vai trÃ²**                    |
| -------------------- | ------------------------------ |
| **AspNetUserTokens** | LÆ°u vÃ  tra cá»©u `refresh_token` |

---

## ğŸ§‘â€ğŸ’» LUá»’NG 6: TRUY Cáº¬P API SAU KHI LOGIN

1. Client gá»i API: `GET /api/products`.
2. Gá»­i kÃ¨m `Authorization: Bearer <access_token>`.
3. Middleware JWT xÃ¡c minh token há»£p lá»‡.
4. API kiá»ƒm tra cÃ¡c claim trong token:
   - Náº¿u cÃ³ `role=admin` â†’ cho phÃ©p thÃªm sáº£n pháº©m.
   - Náº¿u cÃ³ `is_verified=true` â†’ cho phÃ©p Ä‘áº·t hÃ ng.
5. â¡ï¸ KhÃ´ng cáº§n truy váº¥n DB ná»¯a, vÃ¬ táº¥t cáº£ náº±m trong claim Ä‘Ã£ cáº¥p trong token!

---

## âœï¸ LUá»’NG 7: CHá»ˆNH Sá»¬A Há»’ SÆ 

1. NgÆ°á»i dÃ¹ng chá»‰nh sá»­a thÃ´ng tin nhÆ° tÃªn, sá»‘ Ä‘iá»‡n thoáº¡i, Ä‘á»‹a chá»‰.
2. Server gá»i báº£ng **CustomerProfiles** Ä‘á»ƒ cáº­p nháº­t record theo `UserId`.
3. KhÃ´ng tÃ¡c Ä‘á»™ng Ä‘áº¿n báº£ng **AspNetUsers** náº¿u khÃ´ng cÃ³ thay Ä‘á»•i vá» email hoáº·c máº­t kháº©u.

---

## âœ… Tá»•ng há»£p báº£ng dÃ¹ng theo chá»©c nÄƒng

| **Chá»©c nÄƒng**           | **Báº£ng tÆ°Æ¡ng tÃ¡c chÃ­nh**                                        |
| ----------------------- | --------------------------------------------------------------- |
| **ÄÄƒng kÃ½ (local)**     | **AspNetUsers**, **CustomerProfiles**, **AspNetUserClaims**     |
| **ÄÄƒng nháº­p (local)**   | **AspNetUsers**, **AspNetUserClaims**, **AspNetUserRoles**      |
| **ÄÄƒng nháº­p (Google)**  | **AspNetUsers**, **AspNetUserLogins**, **CustomerProfiles**     |
| **Cáº¥p `access_token`**  | **AspNetUserClaims**, **AspNetUserRoles**, **AspNetRoleClaims** |
| **Cáº¥p `refresh_token`** | **AspNetUserTokens**                                            |
| **Gá»i API báº±ng token**  | KhÃ´ng cáº§n query DB â€“ Ä‘á»c tá»« claim                               |
| **Cáº­p nháº­t há»“ sÆ¡**      | **CustomerProfiles**                                            |
