@using Ecommerce.Shared.ViewModels
@model OrderViewModel

<section class="bg-white dark:bg-gray-900 py-20 px-6">
  <div class="max-w-4xl mx-auto">
    @if (Model == null)
    {
      <div class="alert alert-error mb-6 text-center">
        <span>Lá»—i: KhÃ´ng thá»ƒ táº£i chi tiáº¿t Ä‘Æ¡n hÃ ng. Vui lÃ²ng thá»­ láº¡i.</span>
      </div>
      <div class="text-center">
        <a href="/Order/History" class="btn btn-outline text-yellow-900 dark:text-yellow-300">ğŸ”™ Quay láº¡i lá»‹ch sá»­ Ä‘Æ¡n
          hÃ ng</a>
      </div>
    }
    else
    {
      @* @if (TempData["Error"] != null)
      {
        <div class="alert alert-error mb-6 text-center">
          <span>@TempData["Error"]</span>
        </div>
      } *@

      <h1 class="text-3xl font-bold text-yellow-900 dark:text-yellow-300 mb-8 text-center">
        ğŸ“¦ Chi tiáº¿t Ä‘Æ¡n hÃ ng <span class="text-yellow-700 dark:text-yellow-200">#@Model.OrderCode</span>
      </h1>

      <div class="mb-6 text-center">
        <span class="badge badge-lg @(Model.Status == "Paid" ? "bg-green-600" : 
                                                      Model.Status == "Pending" ? "bg-yellow-500" : 
                                                      Model.Status == "Cancelled" ? "bg-red-600" : 
                                                      Model.Status == "Processing" ? "bg-blue-500" : 
                                                      Model.Status == "Delivered" ? "bg-teal-600" : 
                                                      "bg-gray-500") text-white">
          @(Model.Status switch
          {
            "Paid" => "ÄÃ£ thanh toÃ¡n",
            "Pending" => "Äang chá» xá»­ lÃ½",
            "Cancelled" => "ÄÃ£ há»§y",
            "Processing" => "Äang xá»­ lÃ½",
            "Delivered" => "ÄÃ£ giao",
            _ => Model.Status
          })
      </span>
    </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-10">
        <div class="space-y-2">
          <h2 class="font-semibold text-yellow-900 dark:text-yellow-300">ğŸ“ Äá»‹a chá»‰ giao hÃ ng</h2>
          <p class="text-yellow-800 dark:text-yellow-100">@Model.ShippingAddress</p>
        </div>

        <div class="space-y-2">
          <h2 class="font-semibold text-yellow-900 dark:text-yellow-300">ğŸ“† Thá»i gian Ä‘áº·t</h2>
          <p class="text-yellow-800 dark:text-yellow-100">@Model.CreatedDate.ToString("dd/MM/yyyy HH:mm")</p>
          <h2 class="font-semibold text-yellow-900 dark:text-yellow-300">ğŸ“… Thá»i gian giao hÃ ng</h2>
          <p class="text-yellow-800 dark:text-yellow-100">
            @(Model.DeliveryDate.HasValue ? Model.DeliveryDate.Value.ToString("dd/MM/yyyy HH:mm") : "ChÆ°a xÃ¡c Ä‘á»‹nh")
          </p>
          <h2 class="font-semibold text-yellow-900 dark:text-yellow-300">ğŸ’³ PhÆ°Æ¡ng thá»©c thanh toÃ¡n</h2>
          <p class="text-yellow-800 dark:text-yellow-100">
            @(Model.PaymentMethod switch
            {
              "cod" => "Tiá»n máº·t khi nháº­n hÃ ng",
              "bank" => "Chuyá»ƒn khoáº£n ngÃ¢n hÃ ng",
              "momo" => "VÃ­ Ä‘iá»‡n tá»­ (Momo)",
              _ => Model.PaymentMethod
            })
        </p>
      </div>
    </div>

      <div class="mb-8">
        <h2 class="font-semibold text-yellow-900 dark:text-yellow-300 mb-4">ğŸ§ Sáº£n pháº©m Ä‘Ã£ Ä‘áº·t</h2>
        <div class="space-y-3">
        @foreach (var item in Model.Items ?? new List<OrderItemViewModel>())
          {
            <div class="flex justify-between text-yellow-800 dark:text-yellow-100">
              <span>@item.ProductName x @item.Quantity</span>
              <span>@((item.Price * item.Quantity).ToString("N0")) $</span>
            </div>
          }
        </div>
        <div class="divider my-4"></div>
        <div class="flex justify-between font-semibold text-yellow-900 dark:text-yellow-100 text-lg mt-2">
          <span>Tá»•ng cá»™ng</span>
          <span>@Model.TotalAmount.ToString("N0") $</span>
        </div>
      </div>

      @if (!string.IsNullOrEmpty(Model.Note))
      {
        <div class="mb-8">
          <h2 class="font-semibold text-yellow-900 dark:text-yellow-300 mb-2">ğŸ“ Ghi chÃº Ä‘Æ¡n hÃ ng</h2>
          <p class="text-yellow-800 dark:text-yellow-100 italic">@Model.Note</p>
        </div>
      }

      <div class="text-center mt-8 flex justify-center gap-4">
        <a href="/" class="btn btn-outline text-yellow-900 dark:text-yellow-300">ğŸ  Vá» trang chá»§</a>
        <button id="print-order" class="btn bg-yellow-800 text-white">ğŸ–¨ In Ä‘Æ¡n hÃ ng</button>
        @if (Model.Status == "Pending")
        {
          <button id="cancel-order" class="btn bg-red-600 text-white" data-order-id="@Model.Id">âŒ Há»§y Ä‘Æ¡n hÃ ng</button>
        }
      </div>
    }
  </div>
</section>

@section Scripts {
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script>
    $(document).ready(function () {
      // In Ä‘Æ¡n hÃ ng
      $('#print-order').on('click', function () {
        window.print();
      });

      // Há»§y Ä‘Æ¡n hÃ ng
      $('#cancel-order').on('click', function () {
        const orderId = $(this).data('order-id');
        console.log('Cancel order ID:', orderId);
        if (!orderId) {
          showToast('Lá»—i: ID Ä‘Æ¡n hÃ ng khÃ´ng há»£p lá»‡.', 'error');
          return;
        }

        $.ajax({
          url: '/Order/Cancel',
          type: 'POST',
          contentType: 'application/json',
          data: JSON.stringify({ OrderId: orderId }),
          success: function (response) {
            if (response.status) {
              showToast(response.message, 'success');
              // Cáº­p nháº­t tráº¡ng thÃ¡i trÃªn UI
              $('.badge')
                .removeClass('bg-yellow-500')
                .addClass('bg-red-600')
                .text('ÄÃ£ há»§y');
              $('#cancel-order').remove(); // XÃ³a nÃºt há»§y
            } else {
              showToast('Lá»—i: ' + response.message, 'error');
            }
          },
          error: function (xhr, status, error) {
            console.error('CancelOrder error:', xhr, status, error);
            showToast('KhÃ´ng thá»ƒ há»§y Ä‘Æ¡n hÃ ng: ' + error, 'error');
          }
        });
      });
    });
  </script>
}
